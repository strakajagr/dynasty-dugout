AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Dynasty Dugout FastAPI Application with Smart Daily MLB Updates
Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.12
Resources:
  FantasyBaseballApi:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FantasyBaseballApi
      Handler: lambda_handler.handler
      Runtime: python3.12
      Timeout: 200
      Architectures:
      - x86_64
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - rds-data:BeginTransaction
          - rds-data:CommitTransaction
          - rds-data:RollbackTransaction
          Resource: '*'
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          Resource:
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-db-credentials-*
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:rds!cluster-a4ca625a-7cb4-484a-8707-80f27e403c70-*
        - Effect: Allow
          Action:
          - cognito-idp:AdminCreateUser
          - cognito-idp:AdminSetUserPassword
          - cognito-idp:AdminConfirmSignUp
          - cognito-idp:AdminGetUser
          - cognito-idp:AdminInitiateAuth
          - cognito-idp:AdminDeleteUser
          - cognito-idp:ListUsers
          - cognito-idp:AdminUpdateUserAttributes
          - cognito-idp:AdminResetUserPassword
          - cognito-idp:SignUp
          - cognito-idp:ConfirmSignUp
          - cognito-idp:ResendConfirmationCode
          - cognito-idp:ForgotPassword
          - cognito-idp:ConfirmForgotPassword
          - cognito-idp:ChangePassword
          - cognito-idp:DescribeUserPool
          Resource:
          - arn:aws:cognito-idp:us-east-1:584812014683:userpool/us-east-1_OooV5u83w
        - Effect: Allow
          Action:
          - ses:SendEmail
          - ses:SendRawEmail
          - ses:ListVerifiedEmailAddresses
          - ses:GetSendQuota
          - ses:GetSendStatistics
          - ses:VerifyEmailIdentity
          - ses:ListIdentities
          - ses:GetIdentityVerificationAttributes
          - ses:GetIdentityDkimAttributes
          - ses:GetIdentityNotificationAttributes
          Resource: '*'
        - Effect: Allow
          Action:
          - s3:GetObject
          - s3:PutObject
          - s3:DeleteObject
          - s3:GetBucketLocation
          - s3:HeadBucket
          Resource:
          - arn:aws:s3:::dynasty-dugout-profile-pictures
          - arn:aws:s3:::dynasty-dugout-profile-pictures/*
      Events:
        ApiGateway:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
        ApiGatewayRoot:
          Type: Api
          Properties:
            Path: /
            Method: ANY
    Metadata:
      SamResourceId: FantasyBaseballApi
  DynastyDugoutDailyUpdater:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DynastyDugoutDailyUpdater
      Handler: daily_update_lambda.lambda_handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 1024
      Architectures:
      - x86_64
      Environment:
        Variables:
          DATABASE_ARN: arn:aws:rds:us-east-1:584812014683:cluster:fantasy-baseball
          SECRET_ARN: arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-db-credentials-MoEtfC
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - rds-data:BeginTransaction
          - rds-data:CommitTransaction
          - rds-data:RollbackTransaction
          Resource: '*'
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          Resource:
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-db-credentials-*
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:rds!cluster-a4ca625a-7cb4-484a-8707-80f27e403c70-*
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
      Events:
        DailyMLBUpdateSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 11 * * ? *)
            Description: Smart daily MLB stats update at 6 AM EST - incremental approach
            Enabled: true
    Metadata:
      SamResourceId: DynastyDugoutDailyUpdater
  DynastyDugoutManualUpdater:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DynastyDugoutManualUpdater
      Handler: daily_update_lambda.lambda_handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 1024
      Architectures:
      - x86_64
      Environment:
        Variables:
          DATABASE_ARN: arn:aws:rds:us-east-1:584812014683:cluster:fantasy-baseball
          SECRET_ARN: arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-db-credentials-MoEtfC
          UPDATE_TYPE: manual
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - rds-data:BeginTransaction
          - rds-data:CommitTransaction
          - rds-data:RollbackTransaction
          Resource: '*'
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          Resource:
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-db-credentials-*
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:rds!cluster-a4ca625a-7cb4-484a-8707-80f27e403c70-*
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
      Events:
        ManualUpdateTrigger:
          Type: Api
          Properties:
            Path: /api/admin/update-stats
            Method: POST
    Metadata:
      SamResourceId: DynastyDugoutManualUpdater
Outputs:
  DynastyDugoutApiUrl:
    Description: Dynasty Dugout API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  DailyUpdaterArn:
    Description: ARN of the Dynasty Dugout Daily MLB Updater Lambda function
    Value:
      Fn::GetAtt:
      - DynastyDugoutDailyUpdater
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-DailyUpdaterArn
  ManualUpdateUrl:
    Description: Manual stats update endpoint for testing
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/api/admin/update-stats
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ManualUpdateUrl
  UpdateScheduleInfo:
    Description: Dynasty Dugout smart daily update schedule
    Value: Runs daily at 6:00 AM EST (11:00 AM UTC) - Smart incremental approach.
  ArchitectureInfo:
    Description: Dynasty Dugout architecture summary
    Value: 'Modular API: FastAPI + Routers | Daily Updates: Dedicated Lambda | Database:
      Aurora PostgreSQL Serverless | Account Management: S3 + Cognito | Email: SES
      Integration'
