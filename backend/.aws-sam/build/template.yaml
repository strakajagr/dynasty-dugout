AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Dynasty Dugout FastAPI Application with Complete Daily MLB Updates
Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.12
    Environment:
      Variables:
        DB_CLUSTER_ARN: arn:aws:rds:us-east-1:584812014683:cluster:fantasy-baseball-serverless
        DB_SECRET_ARN: arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-baseball-serverless-secret-RBoJdb
Resources:
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      BinaryMediaTypes:
      - multipart/form-data
      - image/*
      - application/octet-stream
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS,PATCH'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Cookie'''
        AllowOrigin: '''*'''
  FantasyBaseballApi:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FantasyBaseballApi
      Handler: fantasy_api.handler
      Runtime: python3.12
      Timeout: 200
      Architectures:
      - x86_64
      Tags:
        CacheBuster: v17-cors-cookies-fixed
      Environment:
        Variables:
          DB_CLUSTER_ARN: arn:aws:rds:us-east-1:584812014683:cluster:fantasy-baseball-serverless
          DB_SECRET_ARN: arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-baseball-serverless-secret-RBoJdb
          LEAGUE_WORKER_LAMBDA_NAME:
            Ref: LeagueCreationWorker
          CORS_FIX_TIMESTAMP: '1756869962'
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          Resource: '*'
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-baseball-serverless-secret-RBoJdb
        - Effect: Allow
          Action:
          - cognito-idp:*
          Resource:
          - arn:aws:cognito-idp:us-east-1:584812014683:userpool/us-east-1_OooV5u83w
        - Effect: Allow
          Action:
          - ses:SendEmail
          Resource: '*'
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:GetObject
          - s3:DeleteObject
          Resource: arn:aws:s3:::dynasty-dugout-profile-pictures/*
        - Effect: Allow
          Action:
          - s3:ListBucket
          Resource: arn:aws:s3:::dynasty-dugout-profile-pictures
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          Resource:
            Fn::GetAtt:
            - LeagueCreationWorker
            - Arn
      Events:
        ApiGateway:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId:
              Ref: ApiGatewayApi
        ApiGatewayOptions:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: OPTIONS
            RestApiId:
              Ref: ApiGatewayApi
    Metadata:
      SamResourceId: FantasyBaseballApi
  LeagueCreationWorker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LeagueCreationWorker
      Handler: worker_function.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      Architectures:
      - x86_64
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          Resource: '*'
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - arn:aws:secretsmanager:us-east-1:584812014683:secret:fantasy-baseball-serverless-secret-RBoJdb
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          Resource:
          - Fn::GetAtt:
            - CalculateRollingStatsFunction
            - Arn
          - arn:aws:lambda:us-east-1:584812014683:function:calculate-rolling-stats
    Metadata:
      SamResourceId: LeagueCreationWorker
  MasterDailyUpdater:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dynasty-dugout-master-daily-updater
      CodeUri: MasterDailyUpdater
      Handler: master_daily_updater.lambda_handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 1024
      Architectures:
      - x86_64
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - secretsmanager:GetSecretValue
          - lambda:InvokeFunction
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6 * * ? *)
            Description: Master daily MLB stats update orchestrator
            Enabled: true
    Metadata:
      SamResourceId: MasterDailyUpdater
  MasterDailyUpdaterEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: MasterDailyUpdater
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*
  CalculateRollingStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: calculate-rolling-stats
      CodeUri: CalculateRollingStatsFunction
      Handler: calculate_rolling_stats.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      Architectures:
      - x86_64
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - secretsmanager:GetSecretValue
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
    Metadata:
      SamResourceId: CalculateRollingStatsFunction
  UpdateActiveAccruedStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: update-active-accrued-stats
      CodeUri: UpdateActiveAccruedStatsFunction
      Handler: update_active_accrued_stats.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      Architectures:
      - x86_64
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - rds-data:ExecuteStatement
          - rds-data:BatchExecuteStatement
          - secretsmanager:GetSecretValue
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
    Metadata:
      SamResourceId: UpdateActiveAccruedStatsFunction
Outputs:
  DynastyDugoutApiUrl:
    Description: Dynasty Dugout API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  MasterDailyUpdaterArn:
    Description: ARN of the Master Daily Updater Lambda function
    Value:
      Fn::GetAtt:
      - MasterDailyUpdater
      - Arn
  CalculateRollingStatsArn:
    Description: ARN of the Calculate Rolling Stats Lambda function
    Value:
      Fn::GetAtt:
      - CalculateRollingStatsFunction
      - Arn
  UpdateActiveAccruedStatsArn:
    Description: ARN of the Update Active Accrued Stats Lambda function
    Value:
      Fn::GetAtt:
      - UpdateActiveAccruedStatsFunction
      - Arn
